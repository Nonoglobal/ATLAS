<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS // ARCHIVES</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; color: #fff; font-family: 'Share Tech Mono', monospace; min-height: 100vh; overflow-x: hidden; }
        
        .grid-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 50px 50px; pointer-events: none; z-index: 0; }

        /* ============ LOADING SCREEN ============ */
        .loading-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; transition: opacity 0.5s; }
        .loading-screen.hidden { opacity: 0; pointer-events: none; }
        
        .loading-logo { font-family: 'Orbitron', sans-serif; font-size: 64px; font-weight: 900; letter-spacing: 15px; margin-bottom: 10px; animation: glitch 2s infinite; }
        @keyframes glitch { 0%,90%,100% { transform: translate(0); } 92% { transform: translate(-3px, 1px); } 94% { transform: translate(3px, -1px); } 96% { transform: translate(-1px, -2px); } }
        
        .loading-subtitle { font-size: 10px; letter-spacing: 5px; color: #444; margin-bottom: 50px; }
        .loading-status { font-size: 11px; color: #666; margin-bottom: 20px; letter-spacing: 2px; }
        
        .loading-progress-bar { width: 300px; height: 2px; background: #1a1a1a; margin-bottom: 30px; overflow: hidden; }
        .loading-progress-fill { height: 100%; background: #fff; width: 0%; transition: width 0.3s; }
        
        .loading-sources { display: flex; flex-direction: column; gap: 10px; width: 280px; }
        .loading-source { display: flex; align-items: center; gap: 12px; padding: 10px 15px; background: rgba(255,255,255,0.02); border: 1px solid #1a1a1a; }
        .loading-source.active { border-color: #333; background: rgba(255,255,255,0.05); }
        .loading-source.done { border-color: #4ade80; background: rgba(74,222,128,0.1); }
        .loading-source.error { border-color: #ff6b6b; opacity: 0.5; }
        .loading-source-icon { font-size: 14px; }
        .loading-source-name { font-size: 10px; letter-spacing: 2px; flex: 1; }
        .loading-source-status { font-size: 9px; color: #666; }
        .loading-source.active .loading-source-status { color: #888; }
        .loading-source.done .loading-source-status { color: #4ade80; }

        /* ============ AUTH SCREEN ============ */
        .auth-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 1000; background: #000; }
        .auth-container.hidden { display: none; }
        .auth-box { background: rgba(10,10,15,0.95); border: 1px solid #222; padding: 50px; width: 100%; max-width: 420px; position: relative; }
        .auth-box::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent, #fff, transparent); }
        .auth-logo { font-family: 'Orbitron', sans-serif; font-size: 48px; font-weight: 900; text-align: center; letter-spacing: 10px; margin-bottom: 10px; background: linear-gradient(135deg, #fff 0%, #666 100%); -webkit-background-clip: text; background-clip: text; color: transparent; }
        .auth-subtitle { text-align: center; font-size: 10px; letter-spacing: 5px; color: #444; margin-bottom: 40px; }
        .auth-tabs { display: flex; margin-bottom: 30px; border-bottom: 1px solid #222; }
        .auth-tab { flex: 1; padding: 15px; background: none; border: none; color: #444; font-family: 'Share Tech Mono', monospace; font-size: 11px; letter-spacing: 3px; cursor: pointer; transition: all 0.3s; }
        .auth-tab.active { color: #fff; border-bottom: 2px solid #fff; }
        .auth-form { display: none; }
        .auth-form.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 10px; letter-spacing: 3px; color: #666; margin-bottom: 8px; }
        .form-group input { width: 100%; padding: 15px; background: #0a0a0f; border: 1px solid #222; color: #fff; font-family: 'Share Tech Mono', monospace; font-size: 14px; transition: border-color 0.3s; }
        .form-group input:focus { outline: none; border-color: #444; }
        .auth-btn { width: 100%; padding: 18px; background: #fff; color: #000; border: none; font-family: 'Orbitron', sans-serif; font-size: 12px; letter-spacing: 5px; cursor: pointer; margin-top: 10px; transition: all 0.3s; }
        .auth-btn:hover { background: #ccc; }
        .auth-error { color: #ff6b6b; font-size: 11px; margin-top: 15px; text-align: center; min-height: 20px; }

        /* ============ MAIN APP ============ */
        .app-container { display: none; position: relative; z-index: 1; }
        .app-container.show { display: block; }
        
        .header { background: rgba(0,0,0,0.95); border-bottom: 1px solid #1a1a1a; padding: 20px 40px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 30px; }
        .logo { font-family: 'Orbitron', sans-serif; font-size: 24px; font-weight: 900; letter-spacing: 5px; }
        .nav-btn { padding: 10px 20px; background: none; border: 1px solid #222; color: #666; font-family: 'Share Tech Mono', monospace; font-size: 10px; letter-spacing: 2px; cursor: pointer; transition: all 0.3s; text-decoration: none; }
        .nav-btn:hover { border-color: #fff; color: #fff; }
        .header-right { display: flex; align-items: center; gap: 20px; }
        .user-email { font-size: 10px; color: #666; letter-spacing: 2px; }
        .logout-btn { padding: 10px 20px; background: none; border: 1px solid #333; color: #666; font-size: 10px; letter-spacing: 2px; cursor: pointer; font-family: 'Share Tech Mono', monospace; }
        .logout-btn:hover { border-color: #ff6b6b; color: #ff6b6b; }

        main { padding: 40px; max-width: 1600px; margin: 0 auto; }
        
        /* Tabs */
        .tabs { display: flex; gap: 0; margin-bottom: 30px; border-bottom: 1px solid #1a1a1a; }
        .tab { padding: 15px 30px; background: none; border: none; color: #444; font-family: 'Orbitron', sans-serif; font-size: 11px; letter-spacing: 3px; cursor: pointer; position: relative; transition: color 0.3s; }
        .tab.active { color: #fff; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: #fff; }
        .tab-badge { background: #333; color: #888; padding: 2px 8px; border-radius: 10px; font-size: 9px; margin-left: 10px; }
        .tab.active .tab-badge { background: #fff; color: #000; }
        .tab-badge.online { background: #4ade80; color: #000; }

        /* Stats */
        .stats-bar { display: flex; gap: 30px; margin-bottom: 30px; padding: 20px 0; border-bottom: 1px solid #1a1a1a; }
        .stat-box { text-align: center; }
        .stat-value { font-family: 'Orbitron', sans-serif; font-size: 24px; font-weight: 700; }
        .stat-label { font-size: 9px; letter-spacing: 2px; color: #444; margin-top: 5px; }

        /* Section */
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .section-title { font-family: 'Orbitron', sans-serif; font-size: 14px; letter-spacing: 5px; }
        .add-btn { padding: 12px 25px; background: #fff; color: #000; border: none; font-family: 'Orbitron', sans-serif; font-size: 10px; letter-spacing: 3px; cursor: pointer; transition: all 0.3s; }
        .add-btn:hover { background: #ccc; }

        /* Documents Grid */
        .documents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Document Card */
        .doc-card { background: rgba(255,255,255,0.02); border: 1px solid #1a1a1a; position: relative; transition: all 0.3s; cursor: pointer; overflow: hidden; }
        .doc-card:hover { border-color: #333; transform: translateY(-2px); }
        .doc-card.online { border-color: #1a3a1a; }
        .doc-card.online:hover { border-color: #4ade80; }
        
        .doc-card-image { width: 100%; height: 160px; object-fit: cover; filter: grayscale(30%); transition: filter 0.3s; }
        .doc-card:hover .doc-card-image { filter: grayscale(0%); }
        .doc-card-placeholder { width: 100%; height: 160px; background: linear-gradient(135deg, #111 0%, #1a1a2e 100%); display: flex; align-items: center; justify-content: center; font-size: 40px; opacity: 0.3; }
        
        .doc-card-body { padding: 20px; }
        .doc-category { font-size: 9px; letter-spacing: 2px; color: #666; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .doc-category .breaking { background: #ff3333; color: #fff; padding: 2px 6px; font-size: 8px; }
        .doc-category .online-badge { background: #4ade80; color: #000; padding: 2px 6px; font-size: 8px; }
        .doc-title { font-size: 14px; line-height: 1.4; color: #fff; margin-bottom: 10px; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .doc-meta { font-size: 10px; color: #444; display: flex; justify-content: space-between; align-items: center; }
        
        .doc-actions { display: flex; gap: 5px; position: absolute; top: 10px; right: 10px; }
        .doc-btn { width: 30px; height: 30px; border-radius: 50%; background: rgba(0,0,0,0.8); border: 1px solid #333; color: #666; font-size: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s; opacity: 0; }
        .doc-card:hover .doc-btn { opacity: 1; }
        .doc-btn:hover { border-color: #fff; color: #fff; }
        .doc-btn.save:hover { border-color: #4ade80; color: #4ade80; }
        .doc-btn.delete:hover { border-color: #ff6b6b; color: #ff6b6b; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; visibility: hidden; transition: all 0.3s; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal { background: #0a0a0f; border: 1px solid #222; padding: 40px; width: 100%; max-width: 500px; position: relative; }
        .modal-title { font-family: 'Orbitron', sans-serif; font-size: 16px; letter-spacing: 5px; margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #222; }
        .modal-close { position: absolute; top: 20px; right: 20px; background: none; border: none; color: #444; font-size: 24px; cursor: pointer; }
        .modal-close:hover { color: #fff; }
        
        .form-group select { width: 100%; padding: 15px; background: #0a0a0f; border: 1px solid #222; color: #fff; font-family: 'Share Tech Mono', monospace; font-size: 14px; cursor: pointer; }
        .form-group select:focus { outline: none; border-color: #444; }
        
        .checkbox-group { margin-top: 20px; }
        .checkbox-label { display: flex; align-items: center; cursor: pointer; gap: 12px; }
        .checkbox-label input { display: none; }
        .checkbox-custom { width: 20px; height: 20px; border: 1px solid #333; display: flex; align-items: center; justify-content: center; transition: all 0.3s; }
        .checkbox-label input:checked + .checkbox-custom { background: #ff3333; border-color: #ff3333; }
        .checkbox-label input:checked + .checkbox-custom::after { content: '‚úì'; color: #fff; font-size: 12px; }
        .checkbox-text { font-size: 11px; letter-spacing: 2px; color: #888; }

        /* Connection Status */
        .connection-status { position: fixed; bottom: 20px; right: 20px; display: flex; align-items: center; gap: 10px; font-size: 9px; letter-spacing: 2px; color: #444; z-index: 100; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #333; }
        .status-dot.connected { background: #4ade80; }

        /* Empty State */
        .empty-state { grid-column: 1/-1; text-align: center; padding: 60px 20px; color: #333; }
        .empty-state-icon { font-size: 64px; margin-bottom: 20px; }
        .empty-state-text { font-size: 12px; letter-spacing: 3px; }

        /* Search */
        .search-container { margin-bottom: 25px; }
        .search-box { display: flex; align-items: center; background: rgba(255,255,255,0.02); border: 1px solid #1a1a1a; padding: 0 15px; transition: border-color 0.3s; }
        .search-box:focus-within { border-color: #444; }
        .search-icon { font-size: 16px; margin-right: 10px; opacity: 0.5; }
        .search-box input { flex: 1; padding: 15px 0; background: none; border: none; color: #fff; font-family: 'Share Tech Mono', monospace; font-size: 13px; }
        .search-box input:focus { outline: none; }
        .search-box input::placeholder { color: #444; }
        .search-clear { background: none; border: none; color: #444; font-size: 20px; cursor: pointer; padding: 10px; display: none; }
        .search-clear.show { display: block; }
        .search-clear:hover { color: #fff; }
        
        .search-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .search-tag { padding: 6px 12px; background: rgba(255,255,255,0.05); border: 1px solid #222; font-size: 10px; letter-spacing: 1px; color: #888; cursor: pointer; transition: all 0.3s; }
        .search-tag:hover { border-color: #444; color: #fff; }
        .search-tag.active { background: #fff; color: #000; border-color: #fff; }
        
        .search-results { margin-top: 10px; font-size: 11px; color: #666; letter-spacing: 1px; min-height: 20px; }

        /* Keyword Tags on Cards */
        .doc-keywords { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
        .doc-keyword { padding: 2px 6px; background: rgba(255,255,255,0.05); font-size: 8px; letter-spacing: 1px; color: #666; }
        .doc-keyword.match { background: rgba(74,222,128,0.2); color: #4ade80; }

        /* Spinner */
        .loading { display: flex; justify-content: center; align-items: center; padding: 40px; grid-column: 1/-1; }
        .spinner { width: 40px; height: 40px; border: 2px solid #222; border-top-color: #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="grid-bg"></div>

    <!-- ============ LOADING SCREEN ============ -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loading-logo">ATLAS</div>
        <div class="loading-subtitle">LIBRARY ARCHIVES SYSTEM</div>
        <div class="loading-status" id="loadingStatusText">Initialisiere System...</div>
        <div class="loading-progress-bar">
            <div class="loading-progress-fill" id="loadingProgressFill"></div>
        </div>
        <div class="loading-sources" id="loadingSources">
            <div class="loading-source" data-source="auth">
                <div class="loading-source-icon">üîê</div>
                <div class="loading-source-name">AUTHENTICATION</div>
                <div class="loading-source-status">Wartend...</div>
            </div>
            <div class="loading-source" data-source="google">
                <div class="loading-source-icon">üìä</div>
                <div class="loading-source-name">GOOGLE FINANCE</div>
                <div class="loading-source-status">Wartend...</div>
            </div>
            <div class="loading-source" data-source="yahoo">
                <div class="loading-source-icon">üì∞</div>
                <div class="loading-source-name">YAHOO NEWS</div>
                <div class="loading-source-status">Wartend...</div>
            </div>
            <div class="loading-source" data-source="cnbc">
                <div class="loading-source-icon">üíπ</div>
                <div class="loading-source-name">CNBC</div>
                <div class="loading-source-status">Wartend...</div>
            </div>
        </div>
    </div>

    <!-- ============ AUTH SCREEN ============ -->
    <div class="auth-container hidden" id="authContainer">
        <div class="auth-box">
            <div class="auth-logo">ATLAS</div>
            <div class="auth-subtitle">LIBRARY ARCHIVES SYSTEM</div>
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="login">ANMELDEN</button>
                <button class="auth-tab" data-tab="register">REGISTRIEREN</button>
            </div>
            <form class="auth-form active" id="loginForm">
                <div class="form-group">
                    <label>E-MAIL</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label>PASSWORT</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit" class="auth-btn">EINLOGGEN</button>
                <div class="auth-error" id="loginError"></div>
            </form>
            <form class="auth-form" id="registerForm">
                <div class="form-group">
                    <label>E-MAIL</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label>PASSWORT</label>
                    <input type="password" id="registerPassword" required>
                </div>
                <button type="submit" class="auth-btn">REGISTRIEREN</button>
                <div class="auth-error" id="registerError"></div>
            </form>
        </div>
    </div>

    <!-- ============ MAIN APP ============ -->
    <div class="app-container" id="appContainer">
        <header class="header">
            <div class="header-left">
                <div class="logo">ATLAS</div>
                <a href="map.html" class="nav-btn">üåç WELTKARTE</a>
            </div>
            <div class="header-right">
                <span class="user-email" id="userEmail"></span>
                <button class="logout-btn" id="logoutBtn">LOGOUT</button>
            </div>
        </header>

        <main>
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab active" data-tab="online">
                    LIVE FEED
                    <span class="tab-badge online" id="onlineCount">0</span>
                </button>
                <button class="tab" data-tab="saved">
                    GESPEICHERT
                    <span class="tab-badge" id="savedCount">0</span>
                </button>
            </div>

            <!-- Stats -->
            <div class="stats-bar">
                <div class="stat-box">
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">GESAMT</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statOnline">0</div>
                    <div class="stat-label">LIVE</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statSaved">0</div>
                    <div class="stat-label">GESPEICHERT</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="statSync">--:--</div>
                    <div class="stat-label">LETZTER SYNC</div>
                </div>
            </div>

            <!-- Online Tab Content -->
            <div class="tab-content active" id="onlineContent">
                <div class="section-header">
                    <h2 class="section-title">LIVE NEWS FEED</h2>
                    <button class="add-btn" id="refreshBtn">‚Üª REFRESH</button>
                </div>
                
                <!-- Search Bar -->
                <div class="search-container">
                    <div class="search-box">
                        <span class="search-icon">üîç</span>
                        <input type="text" id="searchInput" placeholder="Suche nach Schlagw√∂rtern... (z.B. Gr√∂nland, Trump, Bitcoin)">
                        <button class="search-clear" id="searchClear">√ó</button>
                    </div>
                    <div class="search-tags" id="searchTags"></div>
                    <div class="search-results" id="searchResults"></div>
                </div>

                <div class="documents-grid" id="onlineGrid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>

            <!-- Saved Tab Content -->
            <div class="tab-content" id="savedContent">
                <div class="section-header">
                    <h2 class="section-title">GESPEICHERTE ARTIKEL</h2>
                    <button class="add-btn" id="addDocBtn">+ HINZUF√úGEN</button>
                </div>
                <div class="documents-grid" id="savedGrid">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </main>
    </div>

    <!-- ============ ADD ARTICLE MODAL ============ -->
    <div class="modal-overlay" id="addModal">
        <div class="modal">
            <button class="modal-close" id="modalClose">&times;</button>
            <h3 class="modal-title">NEUER ARTIKEL</h3>
            <form id="addDocForm">
                <div class="form-group">
                    <label>ARTIKEL-LINK</label>
                    <input type="url" id="articleUrl" placeholder="https://..." required>
                </div>
                <div class="form-group">
                    <label>TITEL</label>
                    <input type="text" id="articleTitle" placeholder="Titel des Artikels" required>
                </div>
                <div class="form-group">
                    <label>LAND</label>
                    <select id="articleCountry" required>
                        <option value="">Land w√§hlen...</option>
                        <option value="GLOBAL">Global / Weltweit</option>
                        <option value="DE">Deutschland</option>
                        <option value="AT">√ñsterreich</option>
                        <option value="CH">Schweiz</option>
                        <option value="US">USA</option>
                        <option value="GB">Gro√übritannien</option>
                        <option value="FR">Frankreich</option>
                        <option value="RU">Russland</option>
                        <option value="CN">China</option>
                        <option value="JP">Japan</option>
                        <option value="IN">Indien</option>
                        <option value="UA">Ukraine</option>
                        <option value="IL">Israel</option>
                        <option value="IR">Iran</option>
                        <option value="SA">Saudi-Arabien</option>
                        <option value="TR">T√ºrkei</option>
                        <option value="BR">Brasilien</option>
                        <option value="AU">Australien</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>KATEGORIE</label>
                    <select id="articleCategory" required>
                        <option value="">Kategorie w√§hlen...</option>
                        <option value="Politik">Politik</option>
                        <option value="Wirtschaft">Wirtschaft</option>
                        <option value="Finanzen">Finanzen</option>
                        <option value="Geopolitik">Geopolitik</option>
                        <option value="Investment">Investment</option>
                        <option value="M√§rkte">M√§rkte</option>
                        <option value="Technologie">Technologie</option>
                        <option value="Energie">Energie</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>BILD-URL (optional)</label>
                    <input type="url" id="articleImage" placeholder="https://...">
                </div>
                <div class="checkbox-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="articleBreaking">
                        <span class="checkbox-custom"></span>
                        <span class="checkbox-text">‚ö° EILMELDUNG</span>
                    </label>
                </div>
                <button type="submit" class="auth-btn" style="margin-top: 25px;">SPEICHERN</button>
            </form>
        </div>
    </div>

    <div class="connection-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">VERBINDE...</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, query, where, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDrrnWy5d5tlHlxi965WGc_7Gs3GIXY0Qw",
            authDomain: "atlas-4e16d.firebaseapp.com",
            projectId: "atlas-4e16d",
            storageBucket: "atlas-4e16d.firebasestorage.app",
            messagingSenderId: "494472010986",
            appId: "1:494472010986:web:9659fd71b4bcede8770b93"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // DOM Elements
        const loadingScreen = document.getElementById('loadingScreen');
        const authContainer = document.getElementById('authContainer');
        const appContainer = document.getElementById('appContainer');
        const onlineGrid = document.getElementById('onlineGrid');
        const savedGrid = document.getElementById('savedGrid');

        let currentUser = null;
        let onlineArticles = [];
        let savedArticles = [];
        let unsubscribe = null;

        // ============ LOADING SCREEN ============
        function updateLoadingSource(name, status, statusText) {
            const el = document.querySelector(`[data-source="${name}"]`);
            if (!el) return;
            el.className = 'loading-source ' + status;
            el.querySelector('.loading-source-status').textContent = statusText;
        }

        function updateLoadingProgress(percent) {
            document.getElementById('loadingProgressFill').style.width = percent + '%';
        }

        function updateLoadingStatus(text) {
            document.getElementById('loadingStatusText').textContent = text;
        }

        // ============ NEWS SCRAPERS ============
        const newsScrapers = [
            {
                name: 'google',
                displayName: 'Google Finance',
                url: 'https://news.google.com/rss/topics/CAAqJggKIiBDQkFTRWdvSUwyMHZNREpmTjNRU0FtUmxHZ0pCVkNnQVAB',
                parse: parseRSS,
                category: 'Finanzen'
            },
            {
                name: 'yahoo',
                displayName: 'Yahoo Finance',
                url: 'https://feeds.finance.yahoo.com/rss/2.0/headline?s=^GSPC&region=US&lang=en-US',
                parse: parseRSS,
                category: 'M√§rkte'
            },
            {
                name: 'cnbc',
                displayName: 'CNBC',
                url: 'https://www.cnbc.com/id/100003114/device/rss/rss.html',
                parse: parseRSS,
                category: 'Wirtschaft'
            }
        ];

        async function fetchWithProxy(url) {
            const proxies = [
                `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                `https://corsproxy.io/?${encodeURIComponent(url)}`,
                `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];
            
            for (const proxyUrl of proxies) {
                try {
                    const response = await fetch(proxyUrl);
                    if (response.ok) return await response.text();
                } catch (e) { continue; }
            }
            throw new Error('All proxies failed');
        }

        function parseRSS(xml, category) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(xml, 'text/xml');
            const items = doc.querySelectorAll('item');
            const articles = [];
            const now = new Date();
            const oneDayAgo = new Date(now - 24 * 60 * 60 * 1000);

            items.forEach(item => {
                try {
                    const pubDate = new Date(item.querySelector('pubDate')?.textContent);
                    if (pubDate < oneDayAgo) return;

                    const title = item.querySelector('title')?.textContent || '';
                    const link = item.querySelector('link')?.textContent || '';
                    const description = item.querySelector('description')?.textContent || '';
                    
                    // Extract image from description or media content
                    let imageUrl = '';
                    const mediaContent = item.querySelector('media\\:content, content');
                    if (mediaContent) imageUrl = mediaContent.getAttribute('url') || '';
                    
                    if (!imageUrl) {
                        const imgMatch = description.match(/<img[^>]+src="([^">]+)"/);
                        if (imgMatch) imageUrl = imgMatch[1];
                    }

                    if (title && link) {
                        const keywords = extractKeywords(title, description);
                        articles.push({
                            id: 'online_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                            title: title.replace(/<[^>]*>/g, ''),
                            url: link,
                            imageUrl: imageUrl,
                            category: category,
                            country: 'GLOBAL',
                            isBreaking: false,
                            isOnline: true,
                            createdAt: pubDate,
                            source: new URL(link).hostname.replace('www.', ''),
                            keywords: keywords
                        });
                    }
                } catch (e) {}
            });

            return articles;
        }

        async function scrapeAllNews() {
            onlineArticles = [];
            let progress = 25;

            for (const scraper of newsScrapers) {
                updateLoadingSource(scraper.name, 'active', 'Scraping...');
                updateLoadingStatus(`Lade ${scraper.displayName}...`);

                try {
                    const xml = await Promise.race([
                        fetchWithProxy(scraper.url),
                        new Promise((_, r) => setTimeout(() => r(new Error('Timeout')), 15000))
                    ]);

                    const articles = scraper.parse(xml, scraper.category);
                    onlineArticles.push(...articles);
                    
                    updateLoadingSource(scraper.name, 'done', `${articles.length} Artikel`);
                } catch (e) {
                    console.error(`${scraper.name} failed:`, e);
                    updateLoadingSource(scraper.name, 'error', 'Fehlgeschlagen');
                }

                progress += 25;
                updateLoadingProgress(progress);
                await new Promise(r => setTimeout(r, 300));
            }

            // Sort by date
            onlineArticles.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            
            updateLoadingStatus(`${onlineArticles.length} Artikel geladen!`);
            updateLoadingProgress(100);
        }

        // ============ KEYWORD EXTRACTION (NO AI) ============
        const stopWords = new Set([
            'der', 'die', 'das', 'den', 'dem', 'des', 'ein', 'eine', 'einer', 'eines', 'einem', 'einen',
            'und', 'oder', 'aber', 'doch', 'noch', 'schon', 'auch', 'nur', 'sehr', 'mehr', 'viel',
            'ist', 'sind', 'war', 'waren', 'wird', 'werden', 'hat', 'haben', 'hatte', 'hatten',
            'f√ºr', 'mit', 'von', 'bei', 'nach', 'vor', '√ºber', 'unter', 'zwischen', 'durch',
            'auf', 'aus', 'an', 'in', 'im', 'am', 'zum', 'zur', 'vom', 'beim',
            'als', 'wie', 'wenn', 'weil', 'dass', 'ob', 'so', 'da', 'es', 'man',
            'the', 'a', 'an', 'is', 'are', 'was', 'were', 'be', 'been', 'being',
            'have', 'has', 'had', 'do', 'does', 'did', 'will', 'would', 'could', 'should',
            'may', 'might', 'must', 'shall', 'can', 'need', 'dare', 'ought', 'used',
            'to', 'of', 'in', 'for', 'on', 'with', 'at', 'by', 'from', 'as', 'into',
            'through', 'during', 'before', 'after', 'above', 'below', 'between', 'under',
            'and', 'but', 'or', 'nor', 'so', 'yet', 'both', 'either', 'neither',
            'not', 'only', 'own', 'same', 'than', 'too', 'very', 'just', 'also',
            'new', 'says', 'said', 'news', 'report', 'reports', 'update', 'updates'
        ]);

        const knownEntities = {
            // Countries
            countries: ['usa', 'china', 'russia', 'germany', 'france', 'uk', 'japan', 'india', 'brazil', 'canada', 'australia', 'ukraine', 'israel', 'iran', 'saudi', 'turkey', 'mexico', 'korea', 'taiwan', 'gr√∂nland', 'greenland', 'europe', 'asia', 'africa', 'nato', 'eu'],
            // Politicians
            politicians: ['trump', 'biden', 'putin', 'xi', 'jinping', 'scholz', 'macron', 'modi', 'zelensky', 'netanyahu', 'erdogan', 'musk', 'bezos', 'zuckerberg'],
            // Companies
            companies: ['apple', 'google', 'microsoft', 'amazon', 'tesla', 'nvidia', 'meta', 'facebook', 'twitter', 'openai', 'samsung', 'intel', 'amd', 'boeing', 'airbus'],
            // Finance
            finance: ['bitcoin', 'crypto', 'btc', 'eth', 'ethereum', 'stock', 'stocks', 'market', 'markets', 'dow', 'nasdaq', 's&p', 'fed', 'federal', 'reserve', 'inflation', 'interest', 'rate', 'rates', 'dollar', 'euro', 'yen', 'gold', 'oil', 'gas'],
            // Topics
            topics: ['war', 'krieg', 'military', 'milit√§r', 'election', 'wahl', 'trade', 'handel', 'tariff', 'zoll', 'sanction', 'sanctions', 'nuclear', 'nuklear', 'climate', 'klima', 'energy', 'energie', 'tech', 'ai', 'k√ºnstliche', 'intelligenz', 'cyber', 'hack', 'economy', 'wirtschaft', 'recession', 'crisis', 'krise']
        };

        function extractKeywords(title, description = '') {
            const text = (title + ' ' + description).toLowerCase();
            const words = text.match(/[a-zA-Z√§√∂√º√ü√Ñ√ñ√ú]{3,}/g) || [];
            const keywords = new Set();
            
            // Extract words that are not stopwords
            words.forEach(word => {
                if (!stopWords.has(word) && word.length > 3) {
                    // Check if it's a known entity
                    for (const [category, entities] of Object.entries(knownEntities)) {
                        if (entities.some(e => word.includes(e) || e.includes(word))) {
                            keywords.add(word);
                            return;
                        }
                    }
                    // Check for capitalized words in original title (proper nouns)
                    const originalWords = title.split(/\s+/);
                    originalWords.forEach(ow => {
                        if (ow.length > 3 && /^[A-Z√Ñ√ñ√ú]/.test(ow) && ow.toLowerCase() === word) {
                            keywords.add(word);
                        }
                    });
                }
            });

            // Also add any known entities found
            for (const [category, entities] of Object.entries(knownEntities)) {
                entities.forEach(entity => {
                    if (text.includes(entity)) {
                        keywords.add(entity);
                    }
                });
            }

            // Extract numbers with context (percentages, money)
            const numbers = text.match(/\d+[%$‚Ç¨]|\$\d+|\d+\s*(billion|million|trillion|prozent|percent)/gi) || [];
            numbers.forEach(n => keywords.add(n.toLowerCase()));

            return Array.from(keywords).slice(0, 40);
        }

        // ============ SEARCH FUNCTIONALITY ============
        let currentSearchTerm = '';
        let allKeywords = new Set();

        function updateSearchTags() {
            // Collect top keywords from all articles
            const keywordCounts = {};
            onlineArticles.forEach(article => {
                (article.keywords || []).forEach(kw => {
                    keywordCounts[kw] = (keywordCounts[kw] || 0) + 1;
                });
            });

            // Sort by frequency and take top 15
            const topKeywords = Object.entries(keywordCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15)
                .map(([kw]) => kw);

            const tagsContainer = document.getElementById('searchTags');
            tagsContainer.innerHTML = topKeywords.map(kw => 
                `<span class="search-tag ${currentSearchTerm.toLowerCase() === kw ? 'active' : ''}" data-keyword="${kw}">${kw.toUpperCase()}</span>`
            ).join('');

            // Add click handlers
            tagsContainer.querySelectorAll('.search-tag').forEach(tag => {
                tag.addEventListener('click', () => {
                    const keyword = tag.dataset.keyword;
                    if (currentSearchTerm === keyword) {
                        currentSearchTerm = '';
                        document.getElementById('searchInput').value = '';
                    } else {
                        currentSearchTerm = keyword;
                        document.getElementById('searchInput').value = keyword;
                    }
                    filterArticles();
                });
            });
        }

        function filterArticles() {
            const searchTerm = currentSearchTerm.toLowerCase().trim();
            const clearBtn = document.getElementById('searchClear');
            const resultsEl = document.getElementById('searchResults');

            clearBtn.classList.toggle('show', searchTerm.length > 0);

            if (!searchTerm) {
                resultsEl.textContent = '';
                renderOnlineArticles(onlineArticles);
                updateSearchTags();
                return;
            }

            const filtered = onlineArticles.filter(article => {
                const titleMatch = article.title.toLowerCase().includes(searchTerm);
                const keywordMatch = (article.keywords || []).some(kw => kw.includes(searchTerm) || searchTerm.includes(kw));
                return titleMatch || keywordMatch;
            });

            resultsEl.textContent = `${filtered.length} Artikel gefunden f√ºr "${searchTerm}"`;
            renderOnlineArticles(filtered, searchTerm);
            updateSearchTags();
        }

        // Search input handler
        document.getElementById('searchInput').addEventListener('input', (e) => {
            currentSearchTerm = e.target.value;
            filterArticles();
        });

        document.getElementById('searchClear').addEventListener('click', () => {
            currentSearchTerm = '';
            document.getElementById('searchInput').value = '';
            filterArticles();
        });
        // ============ AUTH ============
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                updateLoadingSource('auth', 'done', 'Authentifiziert');
                
                await scrapeAllNews();
                
                setTimeout(() => {
                    loadingScreen.classList.add('hidden');
                    appContainer.classList.add('show');
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('statusDot').classList.add('connected');
                    document.getElementById('statusText').textContent = 'VERBUNDEN';
                    
                    renderOnlineArticles();
                    loadSavedArticles();
                }, 1000);
            } else {
                loadingScreen.classList.add('hidden');
                authContainer.classList.remove('hidden');
            }
        });

        // Auth tabs
        document.querySelectorAll('.auth-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Form').classList.add('active');
            });
        });

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('loginError').textContent = getErrorMessage(error.code);
            }
        });

        // Register
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('registerError').textContent = getErrorMessage(error.code);
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            if (unsubscribe) unsubscribe();
            signOut(auth);
            appContainer.classList.remove('show');
            authContainer.classList.remove('hidden');
        });

        // ============ TABS ============
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab + 'Content').classList.add('active');
            });
        });

        // ============ RENDER FUNCTIONS ============
        function renderOnlineArticles(articles = onlineArticles, highlightTerm = '') {
            if (articles.length === 0) {
                onlineGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üì°</div><div class="empty-state-text">KEINE ARTIKEL GEFUNDEN</div></div>';
                return;
            }

            onlineGrid.innerHTML = articles.map(article => {
                const keywordsHtml = (article.keywords || []).slice(0, 8).map(kw => {
                    const isMatch = highlightTerm && (kw.includes(highlightTerm.toLowerCase()) || highlightTerm.toLowerCase().includes(kw));
                    return `<span class="doc-keyword ${isMatch ? 'match' : ''}">${kw}</span>`;
                }).join('');

                return `
                <div class="doc-card online" onclick="window.openViewer('${encodeURIComponent(article.url)}', '${encodeURIComponent(article.title)}', '${encodeURIComponent(article.category)}', '${article.country}', ${article.isBreaking}, '${encodeURIComponent(article.imageUrl || '')}')">
                    <div class="doc-actions">
                        <button class="doc-btn save" onclick="event.stopPropagation(); window.saveOnlineArticle('${article.id}')" title="Speichern">üíæ</button>
                    </div>
                    ${article.imageUrl ? `<img src="${article.imageUrl}" class="doc-card-image" onerror="this.outerHTML='<div class=\\'doc-card-placeholder\\'>üì∞</div>'">` : '<div class="doc-card-placeholder">üì∞</div>'}
                    <div class="doc-card-body">
                        <div class="doc-category">
                            <span class="online-badge">LIVE</span>
                            ${article.category}
                        </div>
                        <div class="doc-title">${article.title}</div>
                        <div class="doc-meta">
                            <span>${article.source}</span>
                            <span>${formatTime(article.createdAt)}</span>
                        </div>
                        <div class="doc-keywords">${keywordsHtml}</div>
                    </div>
                </div>
            `}).join('');

            document.getElementById('onlineCount').textContent = onlineArticles.length;
            document.getElementById('statOnline').textContent = onlineArticles.length;
            updateTotalStats();
            updateSearchTags();
        }

        function renderSavedArticles() {
            if (savedArticles.length === 0) {
                savedGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìÅ</div><div class="empty-state-text">KEINE GESPEICHERTEN ARTIKEL</div></div>';
                return;
            }

            savedGrid.innerHTML = savedArticles.map(article => `
                <div class="doc-card" onclick="window.openViewer('${encodeURIComponent(article.url)}', '${encodeURIComponent(article.title)}', '${encodeURIComponent(article.category || '')}', '${article.country || ''}', ${article.isBreaking || false}, '${encodeURIComponent(article.imageUrl || '')}')">
                    <div class="doc-actions">
                        <button class="doc-btn delete" onclick="event.stopPropagation(); window.deleteArticle('${article.id}')" title="L√∂schen">√ó</button>
                    </div>
                    ${article.imageUrl ? `<img src="${article.imageUrl}" class="doc-card-image" onerror="this.outerHTML='<div class=\\'doc-card-placeholder\\'>üì∞</div>'">` : '<div class="doc-card-placeholder">üì∞</div>'}
                    <div class="doc-card-body">
                        <div class="doc-category">
                            ${article.isBreaking ? '<span class="breaking">‚ö° EILMELDUNG</span>' : ''}
                            ${article.category || 'ARTIKEL'}
                        </div>
                        <div class="doc-title">${article.title}</div>
                        <div class="doc-meta">
                            <span>${getDomain(article.url)}</span>
                            <span>${formatDate(article.createdAt)}</span>
                        </div>
                    </div>
                </div>
            `).join('');

            document.getElementById('savedCount').textContent = savedArticles.length;
            document.getElementById('statSaved').textContent = savedArticles.length;
            updateTotalStats();
        }

        function updateTotalStats() {
            document.getElementById('statTotal').textContent = onlineArticles.length + savedArticles.length;
            document.getElementById('statSync').textContent = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        }

        // ============ SAVED ARTICLES ============
        function loadSavedArticles() {
            const q = query(
                collection(db, 'documents'),
                where('userId', '==', currentUser.uid),
                orderBy('createdAt', 'desc')
            );

            unsubscribe = onSnapshot(q, (snapshot) => {
                savedArticles = [];
                snapshot.forEach(doc => savedArticles.push({ id: doc.id, ...doc.data() }));
                renderSavedArticles();
            });
        }

        // ============ GLOBAL FUNCTIONS ============
        window.openViewer = function(url, title, category, country, isBreaking, image) {
            const params = new URLSearchParams({ url, title, category, country, breaking: isBreaking, image });
            window.open(`viewer.html?${params.toString()}`, '_blank');
        };

        window.saveOnlineArticle = async function(articleId) {
            const article = onlineArticles.find(a => a.id === articleId);
            if (!article) return;

            try {
                await addDoc(collection(db, 'documents'), {
                    url: article.url,
                    title: article.title,
                    category: article.category,
                    country: article.country,
                    imageUrl: article.imageUrl || '',
                    isBreaking: false,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                alert('Artikel gespeichert!');
            } catch (e) {
                console.error('Save error:', e);
                alert('Fehler beim Speichern');
            }
        };

        window.deleteArticle = async function(articleId) {
            if (!confirm('Artikel wirklich l√∂schen?')) return;
            try {
                await deleteDoc(doc(db, 'documents', articleId));
            } catch (e) {
                console.error('Delete error:', e);
            }
        };

        // ============ REFRESH ============
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            onlineGrid.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            await scrapeAllNews();
            renderOnlineArticles();
        });

        // ============ ADD MODAL ============
        document.getElementById('addDocBtn').addEventListener('click', () => {
            document.getElementById('addModal').classList.add('show');
        });

        document.getElementById('modalClose').addEventListener('click', () => {
            document.getElementById('addModal').classList.remove('show');
        });

        document.getElementById('addDocForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            try {
                await addDoc(collection(db, 'documents'), {
                    url: document.getElementById('articleUrl').value,
                    title: document.getElementById('articleTitle').value,
                    country: document.getElementById('articleCountry').value,
                    category: document.getElementById('articleCategory').value,
                    imageUrl: document.getElementById('articleImage').value || '',
                    isBreaking: document.getElementById('articleBreaking').checked,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                document.getElementById('addModal').classList.remove('show');
                document.getElementById('addDocForm').reset();
            } catch (e) {
                console.error('Add error:', e);
            }
        });

        // ============ HELPERS ============
        function formatTime(date) {
            if (!date) return '-';
            const d = date instanceof Date ? date : new Date(date);
            const now = new Date();
            const diff = Math.floor((now - d) / 1000 / 60);
            if (diff < 60) return `vor ${diff}m`;
            if (diff < 1440) return `vor ${Math.floor(diff / 60)}h`;
            return d.toLocaleDateString('de-DE');
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('de-DE');
        }

        function getDomain(url) {
            try { return new URL(url).hostname.replace('www.', ''); }
            catch { return '-'; }
        }

        function getErrorMessage(code) {
            const msgs = {
                'auth/email-already-in-use': 'E-Mail wird bereits verwendet',
                'auth/invalid-email': 'Ung√ºltige E-Mail',
                'auth/weak-password': 'Passwort zu schwach',
                'auth/user-not-found': 'Benutzer nicht gefunden',
                'auth/wrong-password': 'Falsches Passwort'
            };
            return msgs[code] || 'Fehler aufgetreten';
        }
    </script>
</body>
</html>
