<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATLAS // GLOBAL INTELLIGENCE MAP</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            background: #000;
            color: #fff;
            font-family: 'Share Tech Mono', monospace;
            height: 100vh;
            overflow: hidden;
        }

        /* Scanlines Effect */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                0deg,
                rgba(0, 0, 0, 0.1) 0px,
                rgba(0, 0, 0, 0.1) 1px,
                transparent 1px,
                transparent 2px
            );
            pointer-events: none;
            z-index: 9999;
        }

        /* Header */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(0, 0, 0, 0.95);
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 30px;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: 5px;
            color: #fff;
        }

        .logo-sub {
            font-size: 9px;
            letter-spacing: 3px;
            color: #444;
            border-left: 1px solid #333;
            padding-left: 20px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 10px;
            letter-spacing: 2px;
            color: #666;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 0 0 rgba(74, 222, 128, 0.7); }
            50% { opacity: 0.8; box-shadow: 0 0 0 10px rgba(74, 222, 128, 0); }
        }

        .datetime {
            font-family: 'Orbitron', sans-serif;
            font-size: 12px;
            letter-spacing: 2px;
            color: #fff;
        }

        .back-btn {
            padding: 8px 16px;
            background: none;
            border: 1px solid #333;
            color: #666;
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .back-btn:hover {
            border-color: #fff;
            color: #fff;
        }

        /* Map Container */
        #map {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0a0a0a;
        }

        .leaflet-container {
            background: #0a0a0a;
        }

        /* Breaking News Ticker */
        .breaking-ticker {
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            height: 40px;
            background: rgba(255, 50, 50, 0.95);
            display: none;
            align-items: center;
            overflow: hidden;
            z-index: 900;
        }

        .breaking-ticker.active {
            display: flex;
        }

        .breaking-label {
            background: #fff;
            color: #ff3333;
            padding: 8px 20px;
            font-family: 'Orbitron', sans-serif;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 2px;
            white-space: nowrap;
            animation: flashLabel 1s infinite;
        }

        @keyframes flashLabel {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .breaking-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .breaking-scroll {
            display: flex;
            gap: 100px;
            animation: scrollTicker 30s linear infinite;
            white-space: nowrap;
            padding-left: 100%;
        }

        @keyframes scrollTicker {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }

        .breaking-item {
            font-size: 12px;
            letter-spacing: 1px;
            cursor: pointer;
            transition: opacity 0.3s;
        }

        .breaking-item:hover {
            opacity: 0.7;
        }

        /* Side Panel */
        .side-panel {
            position: fixed;
            top: 60px;
            right: -450px;
            width: 450px;
            height: calc(100vh - 60px);
            background: rgba(5, 5, 10, 0.98);
            border-left: 1px solid #1a1a1a;
            z-index: 800;
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .side-panel.open {
            right: 0;
        }

        .panel-header {
            padding: 25px;
            border-bottom: 1px solid #1a1a1a;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            letter-spacing: 3px;
        }

        .panel-country {
            font-size: 11px;
            color: #666;
            letter-spacing: 2px;
            margin-top: 5px;
        }

        .panel-close {
            background: none;
            border: none;
            color: #666;
            font-size: 24px;
            cursor: pointer;
            transition: color 0.3s;
        }

        .panel-close:hover {
            color: #fff;
        }

        .panel-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: #1a1a1a;
            border-bottom: 1px solid #1a1a1a;
        }

        .panel-stat {
            background: #0a0a0f;
            padding: 15px;
            text-align: center;
        }

        .panel-stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 20px;
            font-weight: 700;
            color: #fff;
        }

        .panel-stat-label {
            font-size: 8px;
            letter-spacing: 2px;
            color: #444;
            margin-top: 5px;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .panel-content::-webkit-scrollbar {
            width: 4px;
        }

        .panel-content::-webkit-scrollbar-track {
            background: #0a0a0a;
        }

        .panel-content::-webkit-scrollbar-thumb {
            background: #333;
        }

        /* Article Cards */
        .article-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid #1a1a1a;
            margin-bottom: 15px;
            transition: all 0.3s;
            cursor: pointer;
            overflow: hidden;
        }

        .article-card:hover {
            border-color: #333;
            transform: translateX(-5px);
        }

        .article-card.breaking {
            border-color: rgba(255, 50, 50, 0.5);
            background: rgba(255, 50, 50, 0.05);
        }

        .article-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            filter: grayscale(30%);
            transition: filter 0.3s;
        }

        .article-card:hover .article-image {
            filter: grayscale(0%);
        }

        .article-image-placeholder {
            width: 100%;
            height: 120px;
            background: linear-gradient(135deg, #111 0%, #1a1a2e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            opacity: 0.3;
        }

        .article-body {
            padding: 15px;
        }

        .article-category {
            font-size: 9px;
            letter-spacing: 2px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .article-category .breaking-badge {
            background: #ff3333;
            color: #fff;
            padding: 2px 8px;
            font-size: 8px;
            animation: flashLabel 1s infinite;
        }

        .article-title {
            font-size: 13px;
            line-height: 1.4;
            color: #fff;
            margin-bottom: 10px;
        }

        .article-meta {
            font-size: 10px;
            color: #444;
            display: flex;
            justify-content: space-between;
        }

        /* Stats Overlay */
        .stats-overlay {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: rgba(5, 5, 10, 0.95);
            border: 1px solid #1a1a1a;
            padding: 20px;
            z-index: 500;
        }

        .stats-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 10px;
            letter-spacing: 3px;
            color: #444;
            margin-bottom: 15px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: #fff;
        }

        .stat-label {
            font-size: 9px;
            letter-spacing: 2px;
            color: #444;
            margin-top: 5px;
        }

        /* Country Info Tooltip */
        .country-tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #333;
            padding: 15px 20px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            font-family: 'Share Tech Mono', monospace;
        }

        .country-tooltip.visible {
            opacity: 1;
        }

        .country-tooltip-name {
            font-family: 'Orbitron', sans-serif;
            font-size: 14px;
            letter-spacing: 2px;
            margin-bottom: 5px;
        }

        .country-tooltip-stats {
            font-size: 11px;
            color: #666;
        }

        .country-tooltip-stats span {
            color: #fff;
        }

        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-logo {
            font-family: 'Orbitron', sans-serif;
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 10px;
            margin-bottom: 30px;
            animation: glitch 2s infinite;
        }

        @keyframes glitch {
            0%, 90%, 100% { transform: translate(0); }
            92% { transform: translate(-3px, 1px); }
            94% { transform: translate(3px, -1px); }
            96% { transform: translate(-1px, -2px); }
            98% { transform: translate(1px, 2px); }
        }

        .loading-bar {
            width: 200px;
            height: 2px;
            background: #111;
            overflow: hidden;
        }

        .loading-progress {
            width: 0%;
            height: 100%;
            background: #fff;
            animation: loadProgress 2s ease-out forwards;
        }

        @keyframes loadProgress {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 10px;
            letter-spacing: 3px;
            color: #444;
        }

        /* No Articles */
        .no-articles {
            text-align: center;
            padding: 40px 20px;
            color: #444;
        }

        .no-articles-icon {
            font-size: 40px;
            margin-bottom: 15px;
            opacity: 0.3;
        }

        .no-articles-text {
            font-size: 11px;
            letter-spacing: 2px;
        }

        /* Legend */
        .legend {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: rgba(5, 5, 10, 0.95);
            border: 1px solid #1a1a1a;
            padding: 15px 20px;
            z-index: 500;
        }

        .legend-title {
            font-family: 'Orbitron', sans-serif;
            font-size: 9px;
            letter-spacing: 2px;
            color: #444;
            margin-bottom: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 10px;
            color: #666;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-color {
            width: 20px;
            height: 12px;
            border: 1px solid;
        }

        .legend-color.none {
            background: transparent;
            border-color: #333;
        }

        .legend-color.low {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .legend-color.medium {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .legend-color.high {
            background: rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.7);
        }

        .legend-color.breaking {
            background: rgba(255, 50, 50, 0.4);
            border-color: #ff3333;
        }
    </style>
</head>
<body>
    <div class="scanlines"></div>

    <!-- Loading Screen -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-logo">ATLAS</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
        <div class="loading-text">LOADING GEOPOLITICAL DATA...</div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <div class="logo">ATLAS</div>
            <div class="logo-sub">GLOBAL INTELLIGENCE MAP</div>
        </div>
        <div class="header-right">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>LIVE</span>
            </div>
            <div class="datetime" id="datetime"></div>
            <a href="index.html" class="back-btn">‚Üê ZUR√úCK</a>
        </div>
    </header>

    <!-- Breaking News Ticker -->
    <div class="breaking-ticker" id="breakingTicker">
        <div class="breaking-label">‚ö° EILMELDUNG</div>
        <div class="breaking-content">
            <div class="breaking-scroll" id="breakingScroll"></div>
        </div>
    </div>

    <!-- Country Tooltip -->
    <div class="country-tooltip" id="countryTooltip">
        <div class="country-tooltip-name" id="tooltipName"></div>
        <div class="country-tooltip-stats" id="tooltipStats"></div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Side Panel -->
    <div class="side-panel" id="sidePanel">
        <div class="panel-header">
            <div>
                <div class="panel-title" id="panelTitle">LAND AUSW√ÑHLEN</div>
                <div class="panel-country" id="panelCountry"></div>
            </div>
            <button class="panel-close" id="panelClose">&times;</button>
        </div>
        <div class="panel-stats">
            <div class="panel-stat">
                <div class="panel-stat-value" id="panelArticles">0</div>
                <div class="panel-stat-label">ARTIKEL</div>
            </div>
            <div class="panel-stat">
                <div class="panel-stat-value" id="panelBreaking">0</div>
                <div class="panel-stat-label">EILMELDUNGEN</div>
            </div>
            <div class="panel-stat">
                <div class="panel-stat-value" id="panelCategories">0</div>
                <div class="panel-stat-label">KATEGORIEN</div>
            </div>
        </div>
        <div class="panel-content" id="panelContent">
            <div class="no-articles">
                <div class="no-articles-icon">üåç</div>
                <div class="no-articles-text">LAND AUSW√ÑHLEN</div>
            </div>
        </div>
    </div>

    <!-- Stats Overlay -->
    <div class="stats-overlay">
        <div class="stats-title">GLOBAL STATISTICS</div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-value" id="totalArticles">0</div>
                <div class="stat-label">ARTIKEL</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalCountries">0</div>
                <div class="stat-label">L√ÑNDER</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalBreaking">0</div>
                <div class="stat-label">EILMELDUNGEN</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="totalToday">0</div>
                <div class="stat-label">HEUTE</div>
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-title">INTEL DENSITY</div>
        <div class="legend-item">
            <div class="legend-color none"></div>
            <span>Keine Daten</span>
        </div>
        <div class="legend-item">
            <div class="legend-color low"></div>
            <span>1-2 Artikel</span>
        </div>
        <div class="legend-item">
            <div class="legend-color medium"></div>
            <span>3-5 Artikel</span>
        </div>
        <div class="legend-item">
            <div class="legend-color high"></div>
            <span>6+ Artikel</span>
        </div>
        <div class="legend-item">
            <div class="legend-color breaking"></div>
            <span>Eilmeldung</span>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            query, 
            where,
            orderBy,
            onSnapshot 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { 
            getAuth, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyDrrnWy5d5tlHlxi965WGc_7Gs3GIXY0Qw",
            authDomain: "atlas-4e16d.firebaseapp.com",
            projectId: "atlas-4e16d",
            storageBucket: "atlas-4e16d.firebasestorage.app",
            messagingSenderId: "494472010986",
            appId: "1:494472010986:web:9659fd71b4bcede8770b93"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Country code mapping (ISO 3166-1 alpha-2 to alpha-3)
        const countryCodeMap = {
            'AF': 'AFG', 'EG': 'EGY', 'AL': 'ALB', 'DZ': 'DZA', 'AR': 'ARG',
            'AM': 'ARM', 'AZ': 'AZE', 'ET': 'ETH', 'AU': 'AUS', 'BE': 'BEL',
            'BO': 'BOL', 'BA': 'BIH', 'BR': 'BRA', 'BG': 'BGR', 'CL': 'CHL',
            'CN': 'CHN', 'DK': 'DNK', 'DE': 'DEU', 'EC': 'ECU', 'EE': 'EST',
            'FI': 'FIN', 'FR': 'FRA', 'GE': 'GEO', 'GH': 'GHA', 'GR': 'GRC',
            'GB': 'GBR', 'IN': 'IND', 'ID': 'IDN', 'IQ': 'IRQ', 'IR': 'IRN',
            'IE': 'IRL', 'IS': 'ISL', 'IL': 'ISR', 'IT': 'ITA', 'JP': 'JPN',
            'YE': 'YEM', 'JO': 'JOR', 'CA': 'CAN', 'KZ': 'KAZ', 'KE': 'KEN',
            'CO': 'COL', 'HR': 'HRV', 'CU': 'CUB', 'LV': 'LVA', 'LB': 'LBN',
            'LY': 'LBY', 'LT': 'LTU', 'MY': 'MYS', 'MA': 'MAR', 'MX': 'MEX',
            'MD': 'MDA', 'MN': 'MNG', 'ME': 'MNE', 'MM': 'MMR', 'NZ': 'NZL',
            'NL': 'NLD', 'NG': 'NGA', 'KP': 'PRK', 'MK': 'MKD', 'NO': 'NOR',
            'AT': 'AUT', 'PK': 'PAK', 'PS': 'PSE', 'PA': 'PAN', 'PE': 'PER',
            'PH': 'PHL', 'PL': 'POL', 'PT': 'PRT', 'RO': 'ROU', 'RU': 'RUS',
            'SA': 'SAU', 'SE': 'SWE', 'CH': 'CHE', 'RS': 'SRB', 'SG': 'SGP',
            'SK': 'SVK', 'SI': 'SVN', 'SO': 'SOM', 'ES': 'ESP', 'ZA': 'ZAF',
            'KR': 'KOR', 'SD': 'SDN', 'SY': 'SYR', 'TW': 'TWN', 'TH': 'THA',
            'CZ': 'CZE', 'TN': 'TUN', 'TR': 'TUR', 'UA': 'UKR', 'HU': 'HUN',
            'US': 'USA', 'UZ': 'UZB', 'VE': 'VEN', 'AE': 'ARE', 'VN': 'VNM',
            'BY': 'BLR'
        };

        // Country names
        const countryNames = {
            'AFG': 'Afghanistan', 'EGY': '√Ñgypten', 'ALB': 'Albanien', 'DZA': 'Algerien',
            'ARG': 'Argentinien', 'ARM': 'Armenien', 'AZE': 'Aserbaidschan', 'ETH': '√Ñthiopien',
            'AUS': 'Australien', 'BEL': 'Belgien', 'BOL': 'Bolivien', 'BIH': 'Bosnien',
            'BRA': 'Brasilien', 'BGR': 'Bulgarien', 'CHL': 'Chile', 'CHN': 'China',
            'DNK': 'D√§nemark', 'DEU': 'Deutschland', 'ECU': 'Ecuador', 'EST': 'Estland',
            'FIN': 'Finnland', 'FRA': 'Frankreich', 'GEO': 'Georgien', 'GHA': 'Ghana',
            'GRC': 'Griechenland', 'GBR': 'Gro√übritannien', 'IND': 'Indien', 'IDN': 'Indonesien',
            'IRQ': 'Irak', 'IRN': 'Iran', 'IRL': 'Irland', 'ISL': 'Island',
            'ISR': 'Israel', 'ITA': 'Italien', 'JPN': 'Japan', 'YEM': 'Jemen',
            'JOR': 'Jordanien', 'CAN': 'Kanada', 'KAZ': 'Kasachstan', 'KEN': 'Kenia',
            'COL': 'Kolumbien', 'HRV': 'Kroatien', 'CUB': 'Kuba', 'LVA': 'Lettland',
            'LBN': 'Libanon', 'LBY': 'Libyen', 'LTU': 'Litauen', 'MYS': 'Malaysia',
            'MAR': 'Marokko', 'MEX': 'Mexiko', 'MDA': 'Moldawien', 'MNG': 'Mongolei',
            'MNE': 'Montenegro', 'MMR': 'Myanmar', 'NZL': 'Neuseeland', 'NLD': 'Niederlande',
            'NGA': 'Nigeria', 'PRK': 'Nordkorea', 'MKD': 'Nordmazedonien', 'NOR': 'Norwegen',
            'AUT': '√ñsterreich', 'PAK': 'Pakistan', 'PSE': 'Pal√§stina', 'PAN': 'Panama',
            'PER': 'Peru', 'PHL': 'Philippinen', 'POL': 'Polen', 'PRT': 'Portugal',
            'ROU': 'Rum√§nien', 'RUS': 'Russland', 'SAU': 'Saudi-Arabien', 'SWE': 'Schweden',
            'CHE': 'Schweiz', 'SRB': 'Serbien', 'SGP': 'Singapur', 'SVK': 'Slowakei',
            'SVN': 'Slowenien', 'SOM': 'Somalia', 'ESP': 'Spanien', 'ZAF': 'S√ºdafrika',
            'KOR': 'S√ºdkorea', 'SDN': 'Sudan', 'SYR': 'Syrien', 'TWN': 'Taiwan',
            'THA': 'Thailand', 'CZE': 'Tschechien', 'TUN': 'Tunesien', 'TUR': 'T√ºrkei',
            'UKR': 'Ukraine', 'HUN': 'Ungarn', 'USA': 'USA', 'UZB': 'Usbekistan',
            'VEN': 'Venezuela', 'ARE': 'VAE', 'VNM': 'Vietnam', 'BLR': 'Wei√ürussland'
        };

        let map;
        let geoJsonLayer;
        let allArticles = [];
        let countryArticles = {};
        let currentUser = null;

        // Initialize
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                initMap();
                loadArticles();
            } else {
                window.location.href = 'index.html';
            }
        });

        async function initMap() {
            map = L.map('map', {
                center: [30, 10],
                zoom: 2.5,
                minZoom: 2,
                maxZoom: 8,
                zoomControl: false
            });

            // Dark tile layer
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_nolabels/{z}/{x}/{y}{r}.png', {
                attribution: '¬© OpenStreetMap ¬© CARTO'
            }).addTo(map);

            L.control.zoom({ position: 'topright' }).addTo(map);

            // Load GeoJSON
            try {
                const response = await fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson');
                const geoData = await response.json();
                
                geoJsonLayer = L.geoJSON(geoData, {
                    style: defaultStyle,
                    onEachFeature: onEachFeature
                }).addTo(map);

                // Update styles if articles already loaded
                if (Object.keys(countryArticles).length > 0) {
                    updateCountryStyles();
                }

                // Hide loading
                setTimeout(() => {
                    document.getElementById('loadingOverlay').classList.add('hidden');
                }, 1500);
            } catch (error) {
                console.error('Error loading GeoJSON:', error);
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        }

        function defaultStyle(feature) {
            return {
                fillColor: 'transparent',
                fillOpacity: 0,
                color: '#333',
                weight: 1,
                opacity: 0.5
            };
        }

        function getCountryStyle(countryCode, articles) {
            if (!articles || articles.length === 0) {
                return {
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    color: '#333',
                    weight: 1,
                    opacity: 0.5
                };
            }

            const hasBreaking = articles.some(a => a.isBreaking);
            const count = articles.length;

            if (hasBreaking) {
                return {
                    fillColor: '#ff3333',
                    fillOpacity: 0.4,
                    color: '#ff3333',
                    weight: 2,
                    opacity: 1
                };
            }

            let fillOpacity;
            if (count >= 6) {
                fillOpacity = 0.4;
            } else if (count >= 3) {
                fillOpacity = 0.25;
            } else {
                fillOpacity = 0.1;
            }

            return {
                fillColor: '#ffffff',
                fillOpacity: fillOpacity,
                color: 'rgba(255, 255, 255, 0.5)',
                weight: 1.5,
                opacity: 1
            };
        }

        function onEachFeature(feature, layer) {
            const countryCode = feature.properties.ISO_A3;
            
            layer.on({
                mouseover: (e) => highlightFeature(e, countryCode, feature),
                mouseout: resetHighlight,
                mousemove: moveTooltip,
                click: () => onCountryClick(countryCode, feature)
            });
        }

        function highlightFeature(e, countryCode, feature) {
            const layer = e.target;
            const articles = countryArticles[countryCode] || [];
            
            layer.setStyle({
                weight: 3,
                color: articles.some(a => a.isBreaking) ? '#ff5555' : '#ffffff',
                fillOpacity: Math.min((layer.options.fillOpacity || 0) + 0.15, 0.6)
            });

            layer.bringToFront();

            // Show tooltip
            const tooltip = document.getElementById('countryTooltip');
            const name = countryNames[countryCode] || (feature && feature.properties && feature.properties.ADMIN) || countryCode || 'Unbekannt';
            const count = articles.length;
            const breaking = articles.filter(a => a.isBreaking).length;

            document.getElementById('tooltipName').textContent = name;
            document.getElementById('tooltipStats').innerHTML = count > 0 
                ? `<span>${count}</span> Artikel ${breaking > 0 ? `| <span style="color:#ff3333">${breaking}</span> Eilmeldungen` : ''}`
                : 'Keine Artikel';

            tooltip.classList.add('visible');
        }

        function moveTooltip(e) {
            const tooltip = document.getElementById('countryTooltip');
            tooltip.style.left = (e.originalEvent.pageX + 15) + 'px';
            tooltip.style.top = (e.originalEvent.pageY + 15) + 'px';
        }

        function resetHighlight(e) {
            const layer = e.target;
            const countryCode = layer.feature.properties.ISO_A3;
            const articles = countryArticles[countryCode] || [];
            
            layer.setStyle(getCountryStyle(countryCode, articles));
            
            document.getElementById('countryTooltip').classList.remove('visible');
        }

        function onCountryClick(countryCode, feature) {
            const articles = countryArticles[countryCode] || [];
            const name = countryNames[countryCode] || (feature && feature.properties && feature.properties.ADMIN) || countryCode || 'Unbekannt';
            
            openPanel(name, countryCode, articles);
        }

        function loadArticles() {
            const q = query(
                collection(db, 'documents'),
                where('userId', '==', currentUser.uid),
                orderBy('createdAt', 'desc')
            );

            onSnapshot(q, (snapshot) => {
                allArticles = [];
                snapshot.forEach(doc => {
                    allArticles.push({ id: doc.id, ...doc.data() });
                });
                
                // Group by country (convert 2-letter to 3-letter code)
                countryArticles = {};
                allArticles.forEach(article => {
                    if (!article.country) return;
                    const code3 = countryCodeMap[article.country];
                    if (!code3) return;
                    
                    if (!countryArticles[code3]) {
                        countryArticles[code3] = [];
                    }
                    countryArticles[code3].push(article);
                });

                updateCountryStyles();
                updateStats();
                updateBreakingTicker();
            });
        }

        function updateCountryStyles() {
            if (!geoJsonLayer) return;

            geoJsonLayer.eachLayer(layer => {
                const countryCode = layer.feature.properties.ISO_A3;
                const articles = countryArticles[countryCode] || [];
                layer.setStyle(getCountryStyle(countryCode, articles));
            });
        }

        function openPanel(name, countryCode, articles) {
            const panel = document.getElementById('sidePanel');

            document.getElementById('panelTitle').textContent = name.toUpperCase();
            document.getElementById('panelCountry').textContent = `${articles.length} INTEL REPORTS`;
            document.getElementById('panelArticles').textContent = articles.length;
            document.getElementById('panelBreaking').textContent = articles.filter(a => a.isBreaking).length;
            document.getElementById('panelCategories').textContent = new Set(articles.map(a => a.category)).size;

            const content = document.getElementById('panelContent');
            
            if (articles.length === 0) {
                content.innerHTML = `
                    <div class="no-articles">
                        <div class="no-articles-icon">üì≠</div>
                        <div class="no-articles-text">KEINE ARTIKEL F√úR DIESES LAND</div>
                    </div>
                `;
            } else {
                content.innerHTML = articles.map(article => `
                    <div class="article-card ${article.isBreaking ? 'breaking' : ''}" onclick="window.open('${article.url}', '_blank')">
                        ${article.imageUrl 
                            ? `<img src="${article.imageUrl}" class="article-image" onerror="this.outerHTML='<div class=\\'article-image-placeholder\\'>üì∞</div>'">`
                            : `<div class="article-image-placeholder">üì∞</div>`
                        }
                        <div class="article-body">
                            <div class="article-category">
                                ${article.isBreaking ? '<span class="breaking-badge">‚ö° EILMELDUNG</span>' : ''}
                                ${article.category || 'ARTIKEL'}
                            </div>
                            <div class="article-title">${article.title}</div>
                            <div class="article-meta">
                                <span>${getDomain(article.url)}</span>
                                <span>${formatDate(article.createdAt)}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            panel.classList.add('open');
        }

        function updateStats() {
            document.getElementById('totalArticles').textContent = allArticles.length;
            document.getElementById('totalCountries').textContent = Object.keys(countryArticles).length;
            document.getElementById('totalBreaking').textContent = allArticles.filter(a => a.isBreaking).length;
            
            const today = new Date().toDateString();
            const todayCount = allArticles.filter(a => {
                if (!a.createdAt) return false;
                const date = a.createdAt.toDate ? a.createdAt.toDate() : new Date(a.createdAt);
                return date.toDateString() === today;
            }).length;
            document.getElementById('totalToday').textContent = todayCount;
        }

        function updateBreakingTicker() {
            const breakingArticles = allArticles.filter(a => a.isBreaking);
            const ticker = document.getElementById('breakingTicker');
            const scroll = document.getElementById('breakingScroll');

            if (breakingArticles.length === 0) {
                ticker.classList.remove('active');
                return;
            }

            ticker.classList.add('active');
            const items = breakingArticles.map(article => {
                const countryCode3 = countryCodeMap[article.country];
                const countryName = countryNames[countryCode3] || 'GLOBAL';
                return `<span class="breaking-item" onclick="window.open('${article.url}', '_blank')">
                    ‚ö° ${article.title} [${countryName}]
                </span>`;
            }).join('');
            
            scroll.innerHTML = items + items;
        }

        // Helpers
        function getDomain(url) {
            try {
                return new URL(url).hostname.replace('www.', '');
            } catch {
                return '-';
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString('de-DE');
        }

        // Update datetime
        function updateDateTime() {
            const now = new Date();
            document.getElementById('datetime').textContent = 
                now.toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' }) + 
                ' ' + 
                now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }
        setInterval(updateDateTime, 1000);
        updateDateTime();

        // Close panel
        document.getElementById('panelClose').addEventListener('click', () => {
            document.getElementById('sidePanel').classList.remove('open');
        });
    </script>
</body>
</html>
